(function() {
    // 获取设备ID
    function getDeviceId() {
        const urlParams = new URLSearchParams(window.location.search);
        let deviceId = urlParams.get('device_id') || localStorage.getItem('tv_device_id');
        
        if (!deviceId) {
            deviceId = 'TV_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8);
            localStorage.setItem('tv_device_id', deviceId);
        }
        
        return deviceId;
    }
    
    // 检查设备授权
    async function checkAuthorization(deviceId) {
        try {
            const response = await fetch('https://cdn.jsdelivr.net/gh/xiaolong-nihao/tv-auth-system/auth-list.json?t=' + Date.now());
            const authData = await response.json();
            return authData.authorized_devices.includes(deviceId);
        } catch (error) {
            console.error('授权检查失败:', error);
            return false;
        }
    }
    
    // 主函数
    async function main() {
        const deviceId = getDeviceId();
        console.log('设备ID:', deviceId);
        
        const isAuthorized = await checkAuthorization(deviceId);
        console.log('授权状态:', isAuthorized);
        
        if (isAuthorized) {
            // 已授权 - 重定向到完整接口
            window.location.href = 'https://gitee.com/yanglong1251/tv-box/raw/master/ok.bmp?device_id=' + encodeURIComponent(deviceId);
        } else {
            // 未授权 - 重定向到受限接口
            window.location.href = 'https://gitee.com/yanglong1251/tv-box/raw/master/cangku.json?device_id=' + encodeURIComponent(deviceId);
        }
    }
    
    // 启动
    main();
})();
