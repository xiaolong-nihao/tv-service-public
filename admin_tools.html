<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --dark: #1f2937;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
            position: relative;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        
        .card-primary {
            border-left: 5px solid var(--primary);
        }
        
        .card-warning {
            border-left: 5px solid var(--warning);
        }
        
        .card-success {
            border-left: 5px solid var(--success);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--light);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background: white;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn-block {
            display: flex;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #0891b2 100%);
            color: white;
        }
        
        .btn-light {
            background: var(--light);
            color: var(--dark);
            border: 2px solid #e2e8f0;
        }
        
        .device-fingerprint {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
        }
        
        .copy-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-authorized {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status-unauthorized {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .device-table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-top: 20px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid #e2e8f0;
        }
        
        .table-row {
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s;
            align-items: center;
        }
        
        .table-row:hover {
            background: #f8fafc;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--light);
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: toastSlideIn 0.3s ease, toastSlideOut 0.3s ease 2.7s;
            max-width: 400px;
        }
        
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- è®¾å¤‡æˆæƒç™»å½•ç•Œé¢ -->
    <div id="authPage" class="container">
        <div class="header">
            <h1>ğŸ”’ å®‰å…¨è®¾å¤‡æˆæƒç³»ç»Ÿ</h1>
            <p>åŸºäºè®¾å¤‡æŒ‡çº¹çš„å®‰å…¨è®¤è¯</p>
        </div>
        
        <div class="main-content">
            <div class="card card-primary">
                <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ”</span> è®¾å¤‡è®¤è¯çŠ¶æ€
                </h3>
                <div id="deviceInfo">
                    <!-- è®¾å¤‡æŒ‡çº¹ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <div id="authSection">
                <div class="card">
                    <h4 style="margin-bottom: 15px;">ç®¡ç†å‘˜èº«ä»½éªŒè¯</h4>
                    <div class="form-group">
                        <label>ç®¡ç†å‘˜å¯†ç ï¼š</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " value="123456">
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="authenticateDevice()" id="authButton">
                        <span>ğŸ”‘</span> éªŒè¯è®¾å¤‡æƒé™
                    </button>
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <small style="color: #64748b;">
                            ğŸ’¡ é¦–æ¬¡ä½¿ç”¨è¯·è¾“å…¥é»˜è®¤å¯†ç : <code>123456</code>
                        </small>
                    </div>
                </div>
            </div>
            
            <div id="pendingSection" style="display: none;">
                <div class="card card-warning">
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">â³</div>
                        <h3 style="margin-bottom: 15px; color: #d97706;">ç­‰å¾…è®¾å¤‡æˆæƒ</h3>
                        <p style="color: #64748b; margin-bottom: 25px; line-height: 1.6;">
                            æ‚¨çš„è®¾å¤‡å·²æäº¤æˆæƒç”³è¯·ï¼Œè¯·é€šçŸ¥ç®¡ç†å‘˜è¿›è¡Œæˆæƒå®¡æ‰¹
                        </p>
                        
                        <div class="device-fingerprint">
                            <div class="copy-badge" onclick="copyFingerprint()">ç‚¹å‡»å¤åˆ¶</div>
                            <strong>è®¾å¤‡æŒ‡çº¹ï¼š</strong>
                            <div id="pendingFingerprint" style="margin-top: 10px;"></div>
                        </div>
                        
                        <div class="grid grid-2" style="margin-top: 20px;">
                            <button class="btn btn-info" onclick="copyFingerprint()">
                                ğŸ“‹ å¤åˆ¶æŒ‡çº¹ä¿¡æ¯
                            </button>
                            <button class="btn btn-light" onclick="checkAuthorizationStatus()">
                                ğŸ”„ æ£€æŸ¥æˆæƒçŠ¶æ€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç®¡ç†ç³»ç»Ÿ -->
    <div id="adminPage" class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ“± è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®‰å…¨è®¾å¤‡ç®¡ç†å¹³å° | <span id="currentDeviceId">å½“å‰è®¾å¤‡</span></p>
        </div>
        
        <div class="main-content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="grid grid-3">
                <div class="card card-success">
                    <div style="text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“Š</div>
                        <h3 id="totalDevices">0</h3>
                        <p style="color: #64748b; font-size: 14px;">æ€»è®¾å¤‡æ•°</p>
                    </div>
                </div>
                <div class="card card-primary">
                    <div style="text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">âœ…</div>
                        <h3 id="authorizedCount">0</h3>
                        <p style="color: #64748b; font-size: 14px;">å·²æˆæƒè®¾å¤‡</p>
                    </div>
                </div>
                <div class="card card-warning">
                    <div style="text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">â³</div>
                        <h3 id="pendingCount">0</h3>
                        <p style="color: #64748b; font-size: 14px;">å¾…æˆæƒè®¾å¤‡</p>
                    </div>
                </div>
            </div>

            <!-- å¾…æˆæƒè®¾å¤‡ -->
            <div id="pendingDevicesSection" style="display: none;">
                <div class="card card-warning">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ”„</span> å¾…æˆæƒè®¾å¤‡
                        <span class="status-badge status-pending" id="pendingBadge">0 ä¸ªè®¾å¤‡ç­‰å¾…</span>
                    </h3>
                    <div id="pendingDevicesList">
                        <!-- å¾…æˆæƒè®¾å¤‡åˆ—è¡¨ -->
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡ç®¡ç† -->
            <div class="card">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ“‹</span> è®¾å¤‡ç®¡ç†
                    </h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showAddDeviceModal()">
                            â• æ·»åŠ è®¾å¤‡
                        </button>
                        <button class="btn btn-success" onclick="refreshPendingDevices()">
                            ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <div class="device-table">
                    <div class="table-header">
                        <div>è®¾å¤‡ä¿¡æ¯</div>
                        <div>æˆæƒæ—¶é—´</div>
                        <div>çŠ¶æ€</div>
                        <div>æ“ä½œ</div>
                    </div>
                    <div id="authorizedDevicesList">
                        <!-- æˆæƒè®¾å¤‡åˆ—è¡¨ -->
                    </div>
                </div>
            </div>

            <!-- å®‰å…¨è®¾ç½® -->
            <div class="card">
                <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    <span>âš™ï¸</span> å®‰å…¨è®¾ç½®
                </h3>
                
                <div class="toggle-label">
                    <span>ğŸ”’ ä¸¥æ ¼è®¾å¤‡éªŒè¯æ¨¡å¼</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="strictMode" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-label">
                    <span>ğŸ“§ æ–°è®¾å¤‡ç”³è¯·é€šçŸ¥</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notifications" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="grid grid-2" style="margin-top: 20px;">
                    <button class="btn btn-danger" onclick="clearAllData()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
                    </button>
                    <button class="btn btn-light" onclick="logout()">
                        ğŸšª å®‰å…¨é€€å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                <span>â•</span> æ·»åŠ æˆæƒè®¾å¤‡
            </h3>
            
            <div class="form-group">
                <label>è®¾å¤‡æŒ‡çº¹ï¼š</label>
                <textarea id="newDeviceFingerprint" class="form-control" rows="4" 
                          placeholder="è¯·ç²˜è´´æ–°è®¾å¤‡çš„å®Œæ•´æŒ‡çº¹ä¿¡æ¯..."></textarea>
            </div>
            
            <div class="form-group">
                <label>è®¾å¤‡å¤‡æ³¨ï¼š</label>
                <input type="text" id="deviceNote" class="form-control" 
                       placeholder="è¾“å…¥è®¾å¤‡æè¿°ï¼ˆä¾‹å¦‚ï¼šåŠå…¬å®¤ç”µè„‘ã€æ‰‹æœºç­‰ï¼‰">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-light" onclick="closeAddDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addAuthorizedDevice()" id="addDeviceButton">
                    æˆæƒè®¾å¤‡
                </button>
            </div>
        </div>
    </div>

    <script>
        // å®‰å…¨é…ç½®
        const SECURITY_CONFIG = {
            ADMIN_PASSWORD: '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92', // 123456
            SESSION_TIMEOUT: 2 * 60 * 60 * 1000,
            MAX_AUTH_DEVICES: 10
        };

        // å…¨å±€å˜é‡
        let deviceFingerprint = null;
        let authorizedDevices = [];
        let currentSession = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ç³»ç»Ÿåˆå§‹åŒ–...");
            initializeSecurity();
            checkExistingSession();
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    authenticateDevice();
                }
            });
        });

        // åˆå§‹åŒ–å®‰å…¨ç³»ç»Ÿ
        async function initializeSecurity() {
            console.log("æ­£åœ¨ç”Ÿæˆè®¾å¤‡æŒ‡çº¹...");
            try {
                deviceFingerprint = await generateDeviceFingerprint();
                console.log("è®¾å¤‡æŒ‡çº¹ç”ŸæˆæˆåŠŸ");
                
                loadAuthorizedDevices();
                displayDeviceInfo();
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
        async function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.platform,
                navigator.language,
                navigator.hardwareConcurrency || 'unknown',
                screen.width + 'x' + screen.height,
                screen.colorDepth + 'bit',
                new Date().getTimezoneOffset().toString(),
                navigator.languages ? navigator.languages.join(',') : navigator.language
            ];
            
            const fingerprintString = components.join('|');
            return await sha256(fingerprintString);
        }

        // SHA256 å“ˆå¸Œå‡½æ•°
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // åˆ›å»ºä¼šè¯
        function createSession() {
            currentSession = {
                fingerprint: deviceFingerprint,
                loginTime: new Date().toISOString(),
                expiry: Date.now() + SECURITY_CONFIG.SESSION_TIMEOUT
            };
            localStorage.setItem('currentSession', JSON.stringify(currentSession));
            console.log("ä¼šè¯åˆ›å»ºæˆåŠŸ");
        }

        // æ£€æŸ¥ç°æœ‰ä¼šè¯
        function checkExistingSession() {
            const savedSession = localStorage.getItem('currentSession');
            if (savedSession) {
                const session = JSON.parse(savedSession);
                if (session.expiry > Date.now() && session.fingerprint === deviceFingerprint) {
                    currentSession = session;
                    showAdminPage();
                    console.log("æ£€æµ‹åˆ°æœ‰æ•ˆä¼šè¯ï¼Œè‡ªåŠ¨ç™»å½•");
                } else {
                    localStorage.removeItem('currentSession');
                }
            }
        }

        // åŠ è½½æˆæƒè®¾å¤‡
        function loadAuthorizedDevices() {
            const saved = localStorage.getItem('authorizedDevices');
            if (saved) {
                authorizedDevices = JSON.parse(saved);
                console.log("åŠ è½½æˆæƒè®¾å¤‡:", authorizedDevices.length);
            } else {
                authorizedDevices = [];
                console.log("æ— æˆæƒè®¾å¤‡æ•°æ®ï¼Œåˆå§‹åŒ–ç©ºæ•°ç»„");
            }
        }

        // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
        function displayDeviceInfo() {
            const deviceInfoDiv = document.getElementById('deviceInfo');
            const shortFingerprint = deviceFingerprint ? deviceFingerprint.substring(0, 32) + '...' : 'ç”Ÿæˆä¸­...';
            
            let statusBadge, statusText;
            
            if (isDeviceAuthorized()) {
                statusBadge = 'status-authorized';
                statusText = 'âœ… è®¾å¤‡å·²æˆæƒ';
            } else if (isDevicePending()) {
                statusBadge = 'status-pending';
                statusText = 'â³ ç­‰å¾…æˆæƒ';
            } else {
                statusBadge = 'status-unauthorized';
                statusText = 'âŒ æœªæˆæƒ';
            }
            
            deviceInfoDiv.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1;">
                        <div style="margin-bottom: 10px;">
                            <strong>è®¾å¤‡æŒ‡çº¹ï¼š</strong>
                            <div style="font-family: monospace; font-size: 13px; color: #64748b; margin-top: 5px;">
                                ${shortFingerprint}
                            </div>
                        </div>
                    </div>
                    <div>
                        <span class="status-badge ${statusBadge}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            `;
            
            if (isDevicePending()) {
                showPendingSection();
            }
        }

        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²æˆæƒ
        function isDeviceAuthorized() {
            return authorizedDevices.some(device => device.fingerprint === deviceFingerprint);
        }

        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨ç­‰å¾…æˆæƒ
        function isDevicePending() {
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            return pendingDevices.includes(deviceFingerprint);
        }

        // æ˜¾ç¤ºç­‰å¾…æˆæƒç•Œé¢
        function showPendingSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'block';
            if (deviceFingerprint) {
                document.getElementById('pendingFingerprint').textContent = deviceFingerprint;
            }
        }

        // è®¾å¤‡è®¤è¯
        async function authenticateDevice() {
            console.log("å¼€å§‹è®¾å¤‡è®¤è¯...");
            
            const authButton = document.getElementById('authButton');
            const originalText = authButton.innerHTML;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                authButton.innerHTML = '<span class="loading"></span> éªŒè¯ä¸­...';
                authButton.disabled = true;
                
                const password = document.getElementById('adminPassword').value;
                
                // å¦‚æœè®¾å¤‡å·²æˆæƒï¼Œç›´æ¥ç™»å½•
                if (isDeviceAuthorized()) {
                    console.log("è®¾å¤‡å·²æˆæƒï¼Œç›´æ¥ç™»å½•");
                    createSession();
                    showAdminPage();
                    return;
                }
                
                // éªŒè¯å¯†ç 
                if (!password) {
                    throw new Error('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ');
                }
                
                const passwordHash = await sha256(password);
                if (passwordHash !== SECURITY_CONFIG.ADMIN_PASSWORD) {
                    throw new Error('ç®¡ç†å‘˜å¯†ç é”™è¯¯');
                }
                
                // å¯†ç æ­£ç¡®ï¼Œå¤„ç†æˆæƒ
                if (authorizedDevices.length === 0) {
                    // é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨æˆæƒå½“å‰è®¾å¤‡
                    console.log("é¦–æ¬¡ä½¿ç”¨ï¼Œè‡ªåŠ¨æˆæƒå½“å‰è®¾å¤‡");
                    authorizedDevices.push({
                        fingerprint: deviceFingerprint,
                        note: 'ç®¡ç†å‘˜è®¾å¤‡',
                        authTime: new Date().toISOString()
                    });
                    localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
                    createSession();
                    showAdminPage();
                    showToast('ğŸ‰ ç®¡ç†å‘˜è®¾å¤‡å·²è‡ªåŠ¨æˆæƒ');
                } else {
                    // æäº¤æˆæƒç”³è¯·
                    console.log("æäº¤æˆæƒç”³è¯·");
                    const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
                    if (!pendingDevices.includes(deviceFingerprint)) {
                        pendingDevices.push(deviceFingerprint);
                        localStorage.setItem('pendingDevices', JSON.stringify(pendingDevices));
                    }
                    showPendingSection();
                    showToast('ğŸ“¨ æˆæƒç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ‰¹');
                }
                
            } catch (error) {
                console.error("è®¤è¯å¤±è´¥:", error);
                showToast(error.message || 'è®¤è¯å¤±è´¥');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                authButton.innerHTML = originalText;
                authButton.disabled = false;
            }
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdminPage() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
            
            // æ›´æ–°ç•Œé¢ä¿¡æ¯
            document.getElementById('currentDeviceId').textContent = deviceFingerprint.substring(0, 16) + '...';
            
            loadAuthorizedDevicesList();
            loadPendingDevices();
            updateDashboard();
        }

        // åŠ è½½æˆæƒè®¾å¤‡åˆ—è¡¨
        function loadAuthorizedDevicesList() {
            const listDiv = document.getElementById('authorizedDevicesList');
            listDiv.innerHTML = '';
            
            authorizedDevices.forEach(device => {
                const isCurrent = device.fingerprint === deviceFingerprint;
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = `
                    <div>
                        <strong>${device.note || 'æœªå‘½åè®¾å¤‡'}</strong>
                        ${isCurrent ? '<br><small style="color: #10b981;">(å½“å‰è®¾å¤‡)</small>' : ''}
                        <br><small style="color: #64748b; font-family: monospace;">${device.fingerprint.substring(0, 24)}...</small>
                    </div>
                    <div>${new Date(device.authTime).toLocaleDateString()}</div>
                    <div>
                        <span class="status-badge status-authorized">å·²æˆæƒ</span>
                    </div>
                    <div class="action-buttons">
                        ${!isCurrent ? `
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="removeDevice('${device.fingerprint}')">
                                ç§»é™¤
                            </button>
                        ` : '<span style="color: #64748b;">å½“å‰è®¾å¤‡</span>'}
                    </div>
                `;
                listDiv.appendChild(row);
            });
        }

        // åŠ è½½å¾…æˆæƒè®¾å¤‡
        function loadPendingDevices() {
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const pendingListDiv = document.getElementById('pendingDevicesList');
            const pendingSection = document.getElementById('pendingDevicesSection');
            
            if (pendingDevices.length === 0) {
                pendingSection.style.display = 'none';
                return;
            }
            
            pendingSection.style.display = 'block';
            document.getElementById('pendingBadge').textContent = `${pendingDevices.length} ä¸ªè®¾å¤‡ç­‰å¾…`;
            pendingListDiv.innerHTML = '';
            
            pendingDevices.forEach((fingerprint, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'pending-item';
                itemDiv.style.cssText = `
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 10px 0;
                    border-left: 4px solid #f59e0b;
                `;
                itemDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>å¾…æˆæƒè®¾å¤‡ #${index + 1}</strong>
                            <div style="font-family: monospace; font-size: 11px; color: #64748b; margin: 5px 0; word-break: break-all;">
                                ${fingerprint}
                            </div>
                        </div>
                        <div>
                            <button class="action-btn" style="background: #10b981; color: white;" onclick="authorizeDevice('${fingerprint}')">
                                âœ… æˆæƒ
                            </button>
                            <button class="action-btn" style="background: #ef4444; color: white;" onclick="rejectDevice('${fingerprint}')">
                                âŒ æ‹’ç»
                            </button>
                        </div>
                    </div>
                `;
                pendingListDiv.appendChild(itemDiv);
            });
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard() {
            document.getElementById('totalDevices').textContent = authorizedDevices.length;
            document.getElementById('authorizedCount').textContent = authorizedDevices.length;
            
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            document.getElementById('pendingCount').textContent = pendingDevices.length;
        }

        // æˆæƒè®¾å¤‡
        function authorizeDevice(fingerprint) {
            const note = prompt('è¯·è¾“å…¥è®¾å¤‡å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:', `è®¾å¤‡-${new Date().toLocaleDateString()}`);
            
            if (authorizedDevices.length >= SECURITY_CONFIG.MAX_AUTH_DEVICES) {
                alert(`å·²è¾¾åˆ°æœ€å¤§æˆæƒè®¾å¤‡æ•°é‡ (${SECURITY_CONFIG.MAX_AUTH_DEVICES})`);
                return;
            }
            
            // æ·»åŠ åˆ°æˆæƒåˆ—è¡¨
            authorizedDevices.push({
                fingerprint: fingerprint,
                note: note || `è®¾å¤‡-${new Date().toLocaleDateString()}`,
                authTime: new Date().toISOString()
            });
            
            // ä»å¾…æˆæƒåˆ—è¡¨ä¸­ç§»é™¤
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const updatedPending = pendingDevices.filter(fp => fp !== fingerprint);
            localStorage.setItem('pendingDevices', JSON.stringify(updatedPending));
            
            // ä¿å­˜æˆæƒè®¾å¤‡åˆ—è¡¨
            localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
            
            // åˆ·æ–°ç•Œé¢
            loadAuthorizedDevicesList();
            loadPendingDevices();
            updateDashboard();
            showToast('âœ… è®¾å¤‡æˆæƒæˆåŠŸ');
        }

        // ç§»é™¤è®¾å¤‡
        function removeDevice(fingerprint) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥è®¾å¤‡çš„æˆæƒå—ï¼Ÿ')) return;
            
            authorizedDevices = authorizedDevices.filter(device => device.fingerprint !== fingerprint);
            localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
            loadAuthorizedDevicesList();
            updateDashboard();
            showToast('è®¾å¤‡å·²ç§»é™¤');
        }

        // æ‹’ç»è®¾å¤‡
        function rejectDevice(fingerprint) {
            if (!confirm('ç¡®å®šè¦æ‹’ç»è¯¥è®¾å¤‡çš„æˆæƒç”³è¯·å—ï¼Ÿ')) return;
            
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const updatedPending = pendingDevices.filter(fp => fp !== fingerprint);
            localStorage.setItem('pendingDevices', JSON.stringify(updatedPending));
            
            loadPendingDevices();
            updateDashboard();
            showToast('è®¾å¤‡æˆæƒç”³è¯·å·²æ‹’ç»');
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'flex';
        }

        // å…³é—­æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†
        function closeAddDeviceModal() {
            document.getElementById('addDeviceModal').style.display = 'none';
        }

        // æ·»åŠ æˆæƒè®¾å¤‡
        function addAuthorizedDevice() {
            const fingerprint = document.getElementById('newDeviceFingerprint').value.trim();
            const note = document.getElementById('deviceNote').value.trim();
            
            if (!fingerprint) {
                alert('è¯·è¾“å…¥è®¾å¤‡æŒ‡çº¹');
                return;
            }
            
            if (authorizedDevices.length >= SECURITY_CONFIG.MAX_AUTH_DEVICES) {
                alert(`å·²è¾¾åˆ°æœ€å¤§æˆæƒè®¾å¤‡æ•°é‡ (${SECURITY_CONFIG.MAX_AUTH_DEVICES})`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (authorizedDevices.some(device => device.fingerprint === fingerprint)) {
                alert('è¯¥è®¾å¤‡å·²æˆæƒ');
                return;
            }
            
            // æ·»åŠ æ–°è®¾å¤‡
            authorizedDevices.push({
                fingerprint: fingerprint,
                note: note || `è®¾å¤‡-${new Date().toLocaleDateString()}`,
                authTime: new Date().toISOString()
            });
            
            // ä»å¾…æˆæƒåˆ—è¡¨ä¸­ç§»é™¤
            const pendingDevices = JSON.parse(localStorage.getItem('pendingDevices') || '[]');
            const updatedPending = pendingDevices.filter(fp => fp !== fingerprint);
            localStorage.setItem('pendingDevices', JSON.stringify(updatedPending));
            
            // ä¿å­˜æˆæƒè®¾å¤‡åˆ—è¡¨
            localStorage.setItem('authorizedDevices', JSON.stringify(authorizedDevices));
            
            closeAddDeviceModal();
            loadAuthorizedDevicesList();
            loadPendingDevices();
            updateDashboard();
            showToast('âœ… è®¾å¤‡æˆæƒæˆåŠŸ');
        }

        // åˆ·æ–°å¾…æˆæƒè®¾å¤‡
        function refreshPendingDevices() {
            loadPendingDevices();
            showToast('ğŸ”„ åˆ—è¡¨å·²åˆ·æ–°');
        }

        // æ£€æŸ¥æˆæƒçŠ¶æ€
        function checkAuthorizationStatus() {
            if (isDeviceAuthorized()) {
                showToast('âœ… æ‚¨çš„è®¾å¤‡å·²è·å¾—æˆæƒï¼Œæ­£åœ¨è·³è½¬...');
                setTimeout(() => {
                    createSession();
                    showAdminPage();
                }, 1000);
            } else {
                showToast('â³ è®¾å¤‡ä»åœ¨ç­‰å¾…æˆæƒå®¡æ‰¹');
            }
        }

        // å¤åˆ¶è®¾å¤‡æŒ‡çº¹
        function copyFingerprint() {
            if (!deviceFingerprint) {
                showToast('è®¾å¤‡æŒ‡çº¹å°šæœªç”Ÿæˆ');
                return;
            }
            
            navigator.clipboard.writeText(deviceFingerprint).then(() => {
                showToast('âœ… è®¾å¤‡æŒ‡çº¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = deviceFingerprint;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('âœ… è®¾å¤‡æŒ‡çº¹å·²å¤åˆ¶');
            });
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                localStorage.clear();
                authorizedDevices = [];
                deviceFingerprint = null;
                currentSession = null;
                showToast('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        // å®‰å…¨é€€å‡º
        function logout() {
            localStorage.removeItem('currentSession');
            showToast('å·²å®‰å…¨é€€å‡º');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // æ˜¾ç¤ºToastæç¤º
        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>ğŸ’¡</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('addDeviceModal');
            if (event.target === modal) {
                closeAddDeviceModal();
            }
        }
    </script>
</body>
</html>
