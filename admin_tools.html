<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç†å¤§å¸ˆ</title>
    
    <!-- PWAåŸºç¡€é…ç½® -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è®¾å¤‡ç®¡ç†">
    <meta name="description" content="ä¸“ä¸šçš„è®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ">
    <meta name="keywords" content="è®¾å¤‡ç®¡ç†,æˆæƒç³»ç»Ÿ,PWA">
    
    <!-- PWAæ¸…å• -->
    <link rel="manifest" href="manifest.json">
    
    <!-- è‹¹æœå›¾æ ‡ -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- æ ·å¼ -->
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .app-container {
            background: white;
            min-height: 100vh;
            border-radius: 0;
            box-shadow: none;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }
        
        .app-header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .app-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 15px;
            background: var(--light-color);
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .section {
            margin: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            margin-bottom: 15px;
            color: var(--dark-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .device-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .device-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        .device-info {
            flex: 1;
        }
        
        .device-id {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .device-meta {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: var(--danger-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        @media (min-width: 768px) {
            body {
                padding: 20px;
                background: #f5f5f5;
            }
            
            .app-container {
                max-width: 400px;
                margin: 0 auto;
                min-height: calc(100vh - 40px);
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }
        }

        /* ToaståŠ¨ç”» */
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
        @keyframes slideUp {
            from { top: 20px; opacity: 1; }
            to { top: -100px; opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å¤´éƒ¨ -->
        <header class="app-header">
            <h1>ğŸ“± è®¾å¤‡ç®¡ç†å¤§å¸ˆ</h1>
            <p>ä¸“ä¸šè®¾å¤‡æˆæƒç®¡ç†ç³»ç»Ÿ</p>
        </header>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="quick-actions">
            <button class="btn btn-primary" onclick="loadDeviceList()">
                ğŸ”„ åˆ·æ–°åˆ—è¡¨
            </button>
            <button class="btn btn-success" onclick="showAddForm()">
                â• æ·»åŠ è®¾å¤‡
            </button>
        </div>
        
        <!-- è®¾å¤‡åˆ—è¡¨ -->
        <div class="section">
            <h3>ğŸ“‹ è®¾å¤‡åˆ—è¡¨</h3>
            <div id="deviceList" class="device-list">
                <div class="loading">
                    â³ åŠ è½½ä¸­...
                </div>
            </div>
        </div>
        
        <!-- æ·»åŠ è®¾å¤‡è¡¨å• -->
        <div id="addForm" class="section" style="display: none;">
            <h3>â• æ·»åŠ æ–°è®¾å¤‡</h3>
            <div class="form-group">
                <label>è®¾å¤‡IDï¼š</label>
                <input type="text" id="newDeviceId" class="form-control" placeholder="è¾“å…¥è®¾å¤‡åºåˆ—å·æˆ–IMEI">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å§“åï¼š</label>
                <input type="text" id="newOwner" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·å§“å">
            </div>
            <div class="form-group">
                <label>è”ç³»æ–¹å¼ï¼š</label>
                <input type="text" id="newContact" class="form-control" placeholder="æ‰‹æœºå·æˆ–å¾®ä¿¡å·">
            </div>
            <div class="form-group">
                <label>å¥—é¤ç±»å‹ï¼š</label>
                <select id="newPackage" class="form-control">
                    <option value="trial">ğŸ ä½“éªŒå¡ (7å¤©)</option>
                    <option value="monthly">â­ æœˆå¡ (30å¤©)</option>
                    <option value="quarterly">ğŸŒŸğŸŒŸ å­£å¡ (90å¤©)</option>
                    <option value="yearly">ğŸŒŸğŸŒŸğŸŒŸ å¹´å¡ (365å¤©)</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-success" onclick="addDevice()">ç¡®è®¤æ·»åŠ </button>
                <button class="btn btn-primary" onclick="hideAddForm()" style="background: #6c757d;">å–æ¶ˆ</button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="section">
            <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
            <div id="statsInfo">
                <div class="loading">åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>
            </div>
        </div>
    </div>
    
    <!-- å®‰è£…æŒ‰é’® -->
    <button id="installBtn" class="install-btn" title="å®‰è£…APP">ğŸ“±</button>

    <script>
        // é…ç½® - ä¿®æ”¹ä¸ºæ‚¨çš„GitHubä»“åº“é“¾æ¥
        const CONFIG = {
            DEVICES_JSON_URL: 'https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/tv-service-config/main/devices.json',
            CACHE_ENABLED: true,
            CACHE_TIME: 5 * 60 * 1000 // 5åˆ†é’Ÿç¼“å­˜
        };
        
        // å®‰è£…PWAç›¸å…³å˜é‡
        let deferredPrompt;
        let devicesCache = null;
        let lastFetchTime = 0;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('è®¾å¤‡ç®¡ç†APPåˆå§‹åŒ–...');
            console.log('æ•°æ®æº:', CONFIG.DEVICES_JSON_URL);
            
            // æ³¨å†ŒService Worker
            registerServiceWorker();
            
            // ç›‘å¬å®‰è£…æç¤º
            setupInstallPrompt();
            
            // åŠ è½½è®¾å¤‡åˆ—è¡¨
            loadDeviceList();
            
            // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
            loadStats();
            
            // æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬
            setupNetworkListener();
        });
        
        // æ³¨å†ŒService Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                    
                    // æ£€æŸ¥æ›´æ–°
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('å‘ç°æ–°ç‰ˆæœ¬ Service Worker');
                    });
                    
                } catch (error) {
                    console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            }
        }
        
        // è®¾ç½®å®‰è£…æç¤º
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // æ˜¾ç¤ºå®‰è£…æŒ‰é’®
                const installBtn = document.getElementById('installBtn');
                installBtn.style.display = 'block';
                
                installBtn.addEventListener('click', async () => {
                    installBtn.style.display = 'none';
                    deferredPrompt.prompt();
                    
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`ç”¨æˆ·å“åº”: ${outcome}`);
                    deferredPrompt = null;
                });
            });
            
            // ç›‘å¬å®‰è£…å®Œæˆ
            window.addEventListener('appinstalled', () => {
                console.log('PWAå·²å®‰è£…');
                document.getElementById('installBtn').style.display = 'none';
                deferredPrompt = null;
            });
        }
        
        // ç½‘ç»œçŠ¶æ€ç›‘å¬
        function setupNetworkListener() {
            window.addEventListener('online', () => {
                console.log('ç½‘ç»œè¿æ¥æ¢å¤ï¼Œé‡æ–°åŠ è½½æ•°æ®');
                showToast('ç½‘ç»œå·²è¿æ¥', 'success');
                loadDeviceList();
            });
            
            window.addEventListener('offline', () => {
                console.log('ç½‘ç»œè¿æ¥æ–­å¼€');
                showToast('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'warning');
            });
        }
        
        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '<div class="loading">â³ åŠ è½½ä¸­...</div>';
            
            try {
                const data = await fetchWithCache(CONFIG.DEVICES_JSON_URL);
                displayDeviceList(data.authorized_devices);
                
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                deviceList.innerHTML = `
                    <div class="error">
                        âŒ åŠ è½½å¤±è´¥: ${error.message}
                        <br><br>
                        <button class="btn btn-primary" onclick="loadDeviceList()">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // å¸¦ç¼“å­˜çš„è·å–å‡½æ•°
        async function fetchWithCache(url) {
            const now = Date.now();
            
            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
            if (CONFIG.CACHE_ENABLED && devicesCache && (now - lastFetchTime) < CONFIG.CACHE_TIME) {
                console.log('ä½¿ç”¨ç¼“å­˜æ•°æ®');
                return devicesCache;
            }
            
            // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
            const response = await fetch(url + '?t=' + now);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // æ›´æ–°ç¼“å­˜
            if (CONFIG.CACHE_ENABLED) {
                devicesCache = data;
                lastFetchTime = now;
            }
            
            return data;
        }
        
        // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
        function displayDeviceList(devices) {
            const deviceList = document.getElementById('deviceList');
            
            if (!devices || devices.length === 0) {
                deviceList.innerHTML = `
                    <div class="empty-state">
                        ğŸ“­ æš‚æ— è®¾å¤‡
                        <br>
                        <small>ç‚¹å‡»"æ·»åŠ è®¾å¤‡"å¼€å§‹ç®¡ç†</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const isExpired = new Date(device.expire_date) < new Date();
                const daysRemaining = Math.ceil((new Date(device.expire_date) - new Date()) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div class="device-item">
                        <div class="device-info">
                            <div class="device-id">${device.device_id}</div>
                            <div class="device-meta">
                                ğŸ‘¤ ${device.owner} â€¢ ğŸ“ ${device.contact}
                                <br>
                                â° åˆ°æœŸ: ${device.expire_date}
                                ${!isExpired ? ` â€¢ å‰©ä½™: ${daysRemaining}å¤©` : ''}
                            </div>
                        </div>
                        <span class="status-badge ${isExpired ? 'status-expired' : 'status-active'}">
                            ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}
                        </span>
                    </div>
                `;
            });
            
            deviceList.innerHTML = html;
        }
        
        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const data = await fetchWithCache(CONFIG.DEVICES_JSON_URL);
                const devices = data.authorized_devices || [];
                
                const total = devices.length;
                const active = devices.filter(d => new Date(d.expire_date) >= new Date()).length;
                const expired = total - active;
                const expiringSoon = devices.filter(d => {
                    const daysRemaining = Math.ceil((new Date(d.expire_date) - new Date()) / (1000 * 60 * 60 * 24));
                    return daysRemaining <= 7 && daysRemaining > 0;
                }).length;
                
                document.getElementById('statsInfo').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                        <div style="padding: 10px; background: #e3f2fd; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${total}</div>
                            <div style="font-size: 0.8rem;">æ€»è®¾å¤‡</div>
                        </div>
                        <div style="padding: 10px; background: #e8f5e8; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${active}</div>
                            <div style="font-size: 0.8rem;">æœ‰æ•ˆè®¾å¤‡</div>
                        </div>
                        <div style="padding: 10px; background: ${expired > 0 ? '#ffebee' : '#e8f5e8'}; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${expired > 0 ? '#dc3545' : 'inherit'}">${expired}</div>
                            <div style="font-size: 0.8rem;">å·²è¿‡æœŸ</div>
                        </div>
                        <div style="padding: 10px; background: ${expiringSoon > 0 ? '#fff3cd' : '#e8f5e8'}; border-radius: 8px;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${expiringSoon > 0 ? '#856404' : 'inherit'}">${expiringSoon}</div>
                            <div style="font-size: 0.8rem;">å³å°†åˆ°æœŸ</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('statsInfo').innerHTML = `
                    <div class="error">
                        âŒ ç»Ÿè®¡åŠ è½½å¤±è´¥
                        <br>
                        <button class="btn btn-primary" onclick="loadStats()">é‡è¯•</button>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ è¡¨å•
        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            // æ»šåŠ¨åˆ°è¡¨å•
            document.getElementById('addForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        // éšè—æ·»åŠ è¡¨å•
        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('newDeviceId').value = '';
            document.getElementById('newOwner').value = '';
            document.getElementById('newContact').value = '';
        }
        
        // æ·»åŠ è®¾å¤‡
        function addDevice() {
            const deviceId = document.getElementById('newDeviceId').value.trim();
            const owner = document.getElementById('newOwner').value.trim();
            const contact = document.getElementById('newContact').value.trim();
            const packageType = document.getElementById('newPackage').value;
            
            if (!deviceId) {
                alert('è¯·è¾“å…¥è®¾å¤‡ID');
                return;
            }
            
            if (!owner) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å§“å');
                return;
            }
            
            const newDevice = {
                device_id: deviceId,
                owner: owner,
                contact: contact || 'æœªæä¾›',
                package: packageType,
                activate_date: new Date().toISOString().split('T')[0],
                expire_date: calculateExpireDate(packageType),
                status: 'active'
            };
            
            // ç”Ÿæˆè®¾å¤‡ä¿¡æ¯ä¾›æ‰‹åŠ¨æ·»åŠ åˆ°JSON
            const deviceInfo = `è¯·æ‰‹åŠ¨å°†ä»¥ä¸‹è®¾å¤‡æ·»åŠ åˆ° devices.json æ–‡ä»¶ä¸­ï¼š\n\n${JSON.stringify(newDevice, null, 2)}`;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            copyToClipboard(deviceInfo);
            
            alert(`âœ… è®¾å¤‡ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·æ›´æ–°GitHubä¸Šçš„devices.jsonæ–‡ä»¶ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"ã€‚`);
            
            hideAddForm();
            // å»¶è¿Ÿåˆ·æ–°ï¼Œç»™ä½ æ—¶é—´æ›´æ–°æ–‡ä»¶
            setTimeout(loadDeviceList, 2000);
        }
        
        // è®¡ç®—åˆ°æœŸæ—¥æœŸ
        function calculateExpireDate(packageType) {
            const today = new Date();
            const durations = {
                'trial': 7,
                'monthly': 30,
                'quarterly': 90,
                'yearly': 365
            };
            
            const days = durations[packageType] || 30;
            today.setDate(today.getDate() + days);
            return today.toISOString().split('T')[0];
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text);
            } else {
                // å…¼å®¹æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                }
                document.body.removeChild(textArea);
            }
        }
        
        // Toastæç¤º
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideDown 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>

