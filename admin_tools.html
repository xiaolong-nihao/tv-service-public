<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æˆæƒç®¡ç†</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œæ·»åŠ æ–°æ ·å¼ */
        
        .device-fixed {
            background: #f0f9ff !important;
            border-left: 4px solid #3b82f6 !important;
        }
        
        .fixed-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .login-badge {
            background: #dcfce7;
            color: #166534;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginPage" class="container">
        <div class="header">
            <h1>ğŸ” è®¾å¤‡æˆæƒç®¡ç†</h1>
            <p>è®¾å¤‡ç™»å½•ç³»ç»Ÿ</p>
        </div>
        
        <div class="main-content">
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“±</div>
                <h2 style="margin-bottom: 10px;">è®¾å¤‡ç™»å½•</h2>
                <p style="color: #666; margin-bottom: 30px; font-size: 14px;">
                    è¯·è¾“å…¥è®¾å¤‡IDå’Œå¯†ç ç™»å½•ç®¡ç†ç³»ç»Ÿ
                </p>
                
                <div class="form-group">
                    <label>è®¾å¤‡IDï¼š</label>
                    <input type="text" id="deviceId" class="form-control" placeholder="è¾“å…¥è®¾å¤‡ID">
                </div>
                
                <div class="form-group">
                    <label>è®¾å¤‡å¯†ç ï¼š</label>
                    <input type="password" id="devicePassword" class="form-control" placeholder="è¾“å…¥è®¾å¤‡å¯†ç ">
                </div>
                
                <button class="btn btn-primary" onclick="loginWithDevice()">
                    ğŸ“± è®¾å¤‡ç™»å½•
                </button>
                
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 14px;">
                    <p>åªæœ‰æˆæƒçš„è®¾å¤‡å¯ä»¥ç™»å½•ç®¡ç†</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç®¡ç†ç•Œé¢ -->
    <div id="adminPage" class="container" style="display: none;">
        <div class="header">
            <h1>ğŸ“± è®¾å¤‡æˆæƒç®¡ç†</h1>
            <p>å½“å‰ç™»å½•è®¾å¤‡: <span id="currentDeviceId">æœªè®¾ç½®</span></p>
        </div>
        
        <div class="main-content">
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="user-info">
                <div class="user-name" id="currentUserName">è®¾å¤‡ç®¡ç†å‘˜</div>
                <div class="user-role" id="currentUserRole">è®¾å¤‡ID: <span id="displayDeviceId">æœªè®¾ç½®</span></div>
                <button class="btn btn-secondary" onclick="logout()" style="margin-top: 10px; padding: 8px 15px; font-size: 14px;">
                    é€€å‡ºç™»å½•
                </button>
            </div>
            
            <!-- å¯¼èˆªæ ‡ç­¾ -->
            <ul class="nav-tabs">
                <li class="nav-tab active" data-tab="dashboard">ğŸ“Š æ•°æ®</li>
                <li class="nav-tab" data-tab="devices">ğŸ“‹ è®¾å¤‡ç®¡ç†</li>
                <li class="nav-tab" data-tab="access">ğŸ” è®¿é—®æ§åˆ¶</li>
                <li class="nav-tab" data-tab="settings">âš™ï¸ è®¾ç½®</li>
            </ul>
            
            <!-- æ•°æ®çœ‹æ¿ä¿æŒä¸å˜ -->
            <div id="dashboard" class="tab-content active">
                <!-- åŸæœ‰å†…å®¹ -->
            </div>
            
            <!-- è®¾å¤‡ç®¡ç† -->
            <div id="devices" class="tab-content">
                <h2 style="margin-bottom: 20px; font-size: 18px;">è®¾å¤‡æˆæƒç®¡ç†</h2>
                
                <div class="action-bar">
                    <button class="btn btn-primary" onclick="openAddDeviceModal()">
                        â• æ·»åŠ è®¾å¤‡
                    </button>
                    <button class="btn btn-success" onclick="exportDevices()">
                        ğŸ“¤ å¯¼å‡ºæ•°æ®
                    </button>
                    <button class="btn btn-warning" onclick="batchExtendDevices()">
                        â±ï¸ æ‰¹é‡å»¶é•¿
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="æœç´¢è®¾å¤‡ID..." onkeyup="filterDevices(this.value)">
                </div>
                
                <div class="device-table">
                    <div class="table-header">
                        <div>è®¾å¤‡ID</div>
                        <div>åˆ°æœŸæ—¶é—´</div>
                        <div>çŠ¶æ€</div>
                        <div>æ“ä½œ</div>
                    </div>
                    <div id="devicesList">
                        <!-- è®¾å¤‡åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
            
            <!-- æ–°å¢è®¿é—®æ§åˆ¶é¡µé¢ -->
            <div id="access" class="tab-content">
                <h2 style="margin-bottom: 20px; font-size: 18px;">ğŸ” è®¾å¤‡è®¿é—®æ§åˆ¶</h2>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">å½“å‰ç™»å½•è®¾å¤‡</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>è®¾å¤‡ID:</strong> <span id="currentLoginDevice">æœªç™»å½•</span>
                        </div>
                        <div>
                            <strong>ç™»å½•æ—¶é—´:</strong> <span id="loginTime">-</span>
                        </div>
                        <div>
                            <strong>è®¾å¤‡æƒé™:</strong> <span class="login-badge">ç®¡ç†æƒé™</span>
                        </div>
                        <div>
                            <strong>çŠ¶æ€:</strong> <span class="status-badge status-active">å·²æˆæƒ</span>
                        </div>
                    </div>
                </div>
                
                <div class="toggle-label">
                    <span>ğŸ”’ å¯ç”¨è®¾å¤‡ç™½åå•</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="enableWhitelist" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="toggle-label">
                    <span>ğŸš« ç¦æ­¢æ–°è®¾å¤‡ç™»å½•</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="blockNewDevices">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label>é»˜è®¤è®¾å¤‡å¯†ç ï¼š</label>
                    <input type="password" class="form-control" id="defaultDevicePassword" value="123456">
                </div>
                
                <h3 style="margin: 20px 0 10px 0;">æˆæƒè®¾å¤‡åˆ—è¡¨</h3>
                <div class="device-table">
                    <div class="table-header">
                        <div>è®¾å¤‡ID</div>
                        <div>ç™»å½•æƒé™</div>
                        <div>æœ€åç™»å½•</div>
                        <div>æ“ä½œ</div>
                    </div>
                    <div id="authorizedDevicesList">
                        <!-- æˆæƒè®¾å¤‡åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½®ä¿æŒä¸å˜ -->
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px; font-size: 18px;">â• æ·»åŠ æ–°è®¾å¤‡</h3>
            
            <div class="form-group">
                <label>è®¾å¤‡IDï¼š</label>
                <input type="text" id="newDeviceId" class="form-control" placeholder="è¾“å…¥è®¾å¤‡åºåˆ—å·æˆ–IMEI">
            </div>
            
            <div class="form-group">
                <label>æ˜¯å¦å…è®¸ç™»å½•ç®¡ç†ï¼š</label>
                <select id="newDeviceLoginAccess" class="form-control">
                    <option value="true">å…è®¸ç™»å½•ç®¡ç†</option>
                    <option value="false">ä»…è®¾å¤‡æˆæƒ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>å¥—é¤ç±»å‹ï¼š</label>
                <select id="newPackage" class="form-control" onchange="updateCustomDays()">
                    <option value="custom">è‡ªå®šä¹‰å¤©æ•°</option>
                    <option value="monthly">æœˆå¡ (30å¤©)</option>
                    <option value="quarterly">å­£å¡ (90å¤©)</option>
                    <option value="yearly">å¹´å¡ (365å¤©)</option>
                    <option value="permanent">æ°¸ä¹…æˆæƒ</option>
                </select>
            </div>
            
            <div class="form-group" id="customDaysGroup" style="display: none;">
                <label>è‡ªå®šä¹‰å¤©æ•°ï¼š</label>
                <input type="number" id="customDays" class="form-control" value="30" min="1" max="3650">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAddDeviceModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addDevice()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // è®¾å¤‡æˆæƒé…ç½®
        const DEVICE_CONFIG = {
            DEFAULT_PASSWORD: '123456',
            ADMIN_DEVICES: ['TV123456789', 'ADMIN001'] // é»˜è®¤ç®¡ç†å‘˜è®¾å¤‡
        };

        // è®¾å¤‡æ•°æ® - å¢åŠ ç™»å½•æƒé™å­—æ®µ
        let devices = [
            {
                id: "TV123456789",
                package: "yearly",
                activate_date: "2024-01-01",
                expire_date: "2024-12-31",
                status: "active",
                days: 365,
                canLogin: true, // æ˜¯å¦å¯ä»¥ç™»å½•ç®¡ç†
                password: "123456",
                lastLogin: null
            },
            {
                id: "865123456789012", 
                package: "monthly",
                activate_date: "2024-01-10",
                expire_date: "2024-02-09",
                status: "active",
                days: 30,
                canLogin: false, // åªèƒ½ä½¿ç”¨ï¼Œä¸èƒ½ç™»å½•ç®¡ç†
                password: "123456",
                lastLogin: null
            }
        ];

        // ç³»ç»Ÿè®¾ç½®
        let systemSettings = {
            enableWhitelist: true,
            blockNewDevices: false,
            defaultDevicePassword: '123456'
        };

        // å½“å‰ç™»å½•çš„è®¾å¤‡
        let currentLoginDevice = null;

        // è®¾å¤‡ç™»å½•
        function loginWithDevice() {
            const deviceId = document.getElementById('deviceId').value.trim();
            const password = document.getElementById('devicePassword').value.trim();
            
            if (!deviceId || !password) {
                showToast('è¯·è¾“å…¥è®¾å¤‡IDå’Œå¯†ç ');
                return;
            }
            
            // æŸ¥æ‰¾è®¾å¤‡
            const device = devices.find(d => d.id === deviceId);
            
            if (!device) {
                showToast('è®¾å¤‡IDä¸å­˜åœ¨');
                return;
            }
            
            // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å…è®¸ç™»å½•
            if (!device.canLogin) {
                showToast('è¯¥è®¾å¤‡æ²¡æœ‰ç®¡ç†ç™»å½•æƒé™');
                return;
            }
            
            // éªŒè¯å¯†ç 
            if (device.password !== password) {
                showToast('è®¾å¤‡å¯†ç é”™è¯¯');
                return;
            }
            
            // æ£€æŸ¥è®¾å¤‡æˆæƒçŠ¶æ€
            if (device.package !== "permanent" && new Date(device.expire_date) < new Date()) {
                showToast('è®¾å¤‡æˆæƒå·²è¿‡æœŸ');
                return;
            }
            
            // ç™»å½•æˆåŠŸ
            currentLoginDevice = device;
            device.lastLogin = new Date().toISOString();
            
            localStorage.setItem('currentLoginDevice', JSON.stringify(device));
            showAdminPage();
            showToast(`âœ… è®¾å¤‡ ${deviceId} ç™»å½•æˆåŠŸ`);
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdminPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
            
            // æ›´æ–°è®¾å¤‡ä¿¡æ¯
            if (currentLoginDevice) {
                document.getElementById('currentDeviceId').textContent = currentLoginDevice.id;
                document.getElementById('displayDeviceId').textContent = currentLoginDevice.id;
                document.getElementById('currentLoginDevice').textContent = currentLoginDevice.id;
                document.getElementById('loginTime').textContent = new Date().toLocaleString();
            }
            
            // åŠ è½½æ•°æ®
            loadDevices();
            updateStats();
            loadAuthorizedDevices();
            loadSettings();
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨ - å¢å¼ºç‰ˆ
        function loadDevices() {
            const devicesList = document.getElementById('devicesList');
            devicesList.innerHTML = '';
            
            devices.forEach((device) => {
                const isPermanent = device.package === "permanent";
                const isExpired = !isPermanent && new Date(device.expire_date) < new Date();
                const daysRemaining = isPermanent ? Infinity : Math.ceil((new Date(device.expire_date) - new Date()) / (1000 * 60 * 60 * 24));
                
                let statusClass = 'status-active';
                let statusText = 'æœ‰æ•ˆ';
                
                if (isPermanent) {
                    statusClass = 'status-permanent';
                    statusText = 'æ°¸ä¹…';
                } else if (isExpired) {
                    statusClass = 'status-expired';
                    statusText = 'å·²è¿‡æœŸ';
                } else if (daysRemaining <= 7) {
                    statusClass = 'status-warning';
                    statusText = 'å³å°†åˆ°æœŸ';
                }
                
                const row = document.createElement('div');
                row.className = 'table-row' + (device.canLogin ? ' device-fixed' : '');
                row.innerHTML = `
                    <div>
                        ${device.id}
                        ${device.canLogin ? '<span class="fixed-badge">å¯ç™»å½•</span>' : ''}
                        ${currentLoginDevice && device.id === currentLoginDevice.id ? '<span class="login-badge">å½“å‰</span>' : ''}
                    </div>
                    <div>
                        ${device.expire_date} 
                        ${!isPermanent && !isExpired ? `<br><small>å‰©ä½™ ${daysRemaining} å¤©</small>` : ''}
                    </div>
                    <div>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </div>
                    <div class="device-actions">
                        <button class="btn btn-warning" onclick="extendDevice('${device.id}')" 
                                style="padding: 6px 10px; font-size: 11px;">
                            â±ï¸ å»¶é•¿
                        </button>
                        <button class="btn btn-primary" onclick="toggleDeviceLogin('${device.id}')" 
                                style="padding: 6px 10px; font-size: 11px;">
                            ${device.canLogin ? 'ğŸ”’' : 'ğŸ”“'} æƒé™
                        </button>
                        <button class="btn btn-danger" onclick="deleteDevice('${device.id}')" 
                                style="padding: 6px 10px; font-size: 11px;">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                    <div class="device-details">
                        <div><strong>æ¿€æ´»æ—¥æœŸ:</strong> ${device.activate_date}</div>
                        <div><strong>å¥—é¤ç±»å‹:</strong> ${getPackageText(device.package)}</div>
                        <div><strong>ç™»å½•æƒé™:</strong> ${device.canLogin ? 'å…è®¸ç™»å½•ç®¡ç†' : 'ä»…è®¾å¤‡ä½¿ç”¨'}</div>
                        ${device.lastLogin ? `<div><strong>æœ€åç™»å½•:</strong> ${new Date(device.lastLogin).toLocaleString()}</div>` : ''}
                    </div>
                `;
                devicesList.appendChild(row);
            });
        }

        // åŠ è½½æˆæƒè®¾å¤‡åˆ—è¡¨
        function loadAuthorizedDevices() {
            const authorizedDevicesList = document.getElementById('authorizedDevicesList');
            authorizedDevicesList.innerHTML = '';
            
            const authorizedDevices = devices.filter(device => device.canLogin);
            
            authorizedDevices.forEach(device => {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = `
                    <div>${device.id}</div>
                    <div>
                        <span class="status-badge ${device.canLogin ? 'status-active' : 'status-expired'}">
                            ${device.canLogin ? 'ç®¡ç†æƒé™' : 'ä½¿ç”¨æƒé™'}
                        </span>
                    </div>
                    <div>
                        ${device.lastLogin ? new Date(device.lastLogin).toLocaleString() : 'ä»æœªç™»å½•'}
                    </div>
                    <div>
                        <button class="btn btn-warning" onclick="resetDevicePassword('${device.id}')" 
                                style="padding: 4px 8px; font-size: 11px;">
                            ğŸ”‘ é‡ç½®å¯†ç 
                        </button>
                        <button class="btn btn-danger" onclick="revokeLoginAccess('${device.id}')" 
                                style="padding: 4px 8px; font-size: 11px;">
                            ğŸš« å–æ¶ˆç™»å½•
                        </button>
                    </div>
                `;
                authorizedDevicesList.appendChild(row);
            });
        }

        // åˆ‡æ¢è®¾å¤‡ç™»å½•æƒé™
        function toggleDeviceLogin(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            device.canLogin = !device.canLogin;
            if (device.canLogin && !device.password) {
                device.password = systemSettings.defaultDevicePassword;
            }
            
            loadDevices();
            loadAuthorizedDevices();
            showToast(`è®¾å¤‡ ${deviceId} ${device.canLogin ? 'å·²å…è®¸ç™»å½•ç®¡ç†' : 'å·²ç¦æ­¢ç™»å½•ç®¡ç†'}`);
        }

        // é‡ç½®è®¾å¤‡å¯†ç 
        function resetDevicePassword(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            const newPassword = prompt(`è¯·è¾“å…¥è®¾å¤‡ ${deviceId} çš„æ–°å¯†ç :`, systemSettings.defaultDevicePassword);
            if (newPassword) {
                device.password = newPassword;
                showToast(`è®¾å¤‡ ${deviceId} å¯†ç å·²é‡ç½®`);
            }
        }

        // å–æ¶ˆè®¾å¤‡ç™»å½•æƒé™
        function revokeLoginAccess(deviceId) {
            if (!confirm(`ç¡®å®šè¦å–æ¶ˆè®¾å¤‡ ${deviceId} çš„ç™»å½•æƒé™å—ï¼Ÿ`)) return;
            
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                device.canLogin = false;
                loadDevices();
                loadAuthorizedDevices();
                showToast(`è®¾å¤‡ ${deviceId} ç™»å½•æƒé™å·²å–æ¶ˆ`);
            }
        }

        // æ·»åŠ è®¾å¤‡ - å¢å¼ºç‰ˆ
        function addDevice() {
            const deviceId = document.getElementById('newDeviceId').value.trim();
            const canLogin = document.getElementById('newDeviceLoginAccess').value === 'true';
            const packageType = document.getElementById('newPackage').value;
            const customDays = parseInt(document.getElementById('customDays').value) || systemSettings.defaultDays;
            
            if (!deviceId) {
                showToast('è¯·è¾“å…¥è®¾å¤‡ID');
                return;
            }
            
            if (devices.some(d => d.id === deviceId)) {
                showToast('è®¾å¤‡IDå·²å­˜åœ¨');
                return;
            }
            
            // è®¡ç®—åˆ°æœŸæ—¥æœŸ
            const today = new Date();
            let expireDate, days;
            
            if (packageType === 'permanent') {
                expireDate = 'æ°¸ä¹…';
                days = 'æ°¸ä¹…';
            } else {
                if (packageType === 'custom') {
                    days = customDays;
                } else {
                    const durations = {
                        'monthly': 30,
                        'quarterly': 90,
                        'yearly': 365
                    };
                    days = durations[packageType] || systemSettings.defaultDays;
                }
                
                today.setDate(today.getDate() + days);
                expireDate = today.toISOString().split('T')[0];
            }
            
            // æ·»åŠ æ–°è®¾å¤‡
            const newDevice = {
                id: deviceId,
                package: packageType,
                activate_date: new Date().toISOString().split('T')[0],
                expire_date: expireDate,
                days: days,
                status: packageType === 'permanent' ? 'permanent' : 'active',
                canLogin: canLogin,
                password: canLogin ? systemSettings.defaultDevicePassword : null,
                lastLogin: null
            };
            
            devices.unshift(newDevice);
            loadDevices();
            loadAuthorizedDevices();
            updateStats();
            closeAddDeviceModal();
            
            showToast(`âœ… è®¾å¤‡ ${deviceId} æ·»åŠ æˆåŠŸï¼${canLogin ? 'å¯ç™»å½•ç®¡ç†' : 'ä»…è®¾å¤‡ä½¿ç”¨'}`);
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const savedDevice = localStorage.getItem('currentLoginDevice');
            if (savedDevice) {
                currentLoginDevice = JSON.parse(savedDevice);
                // éªŒè¯è®¾å¤‡æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                const device = devices.find(d => d.id === currentLoginDevice.id && d.canLogin);
                if (device) {
                    showAdminPage();
                    return;
                }
            }
            showLoginPage();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('currentLoginDevice');
                currentLoginDevice = null;
                showLoginPage();
                showToast('å·²é€€å‡ºç™»å½•');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupTabNavigation();
            loadSettings();
        });

        // å…¶ä½™å‡½æ•°ä¿æŒä¸å˜...
    </script>
</body>
</html>
