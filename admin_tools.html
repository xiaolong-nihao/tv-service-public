<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡æˆæƒç®¡ç†</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œæ·»åŠ æ–°æ ·å¼ */
        
        .device-fixed {
            background: #f0f9ff !important;
            border-left: 4px solid #3b82f6 !important;
        }
        
        .fixed-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        .security-settings {
            background: #fef7ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ä¿æŒä¸å˜ -->
    
    <!-- ä¸»ç®¡ç†ç•Œé¢ -->
    <div id="adminPage" class="container" style="display: none;">
        <!-- å¤´éƒ¨ä¿æŒä¸å˜ -->
        
        <div class="main-content">
            <!-- ç”¨æˆ·ä¿¡æ¯ä¿æŒä¸å˜ -->
            
            <!-- å¯¼èˆªæ ‡ç­¾ - æ·»åŠ å®‰å…¨æ ‡ç­¾ -->
            <ul class="nav-tabs">
                <li class="nav-tab active" data-tab="dashboard">ğŸ“Š æ•°æ®</li>
                <li class="nav-tab" data-tab="devices">ğŸ“‹ è®¾å¤‡</li>
                <li class="nav-tab" data-tab="security">ğŸ”’ å®‰å…¨</li>
                <li class="nav-tab" data-tab="settings">âš™ï¸ è®¾ç½®</li>
            </ul>
            
            <!-- æ•°æ®çœ‹æ¿ä¿æŒä¸å˜ -->
            
            <!-- è®¾å¤‡ç®¡ç†ä¿æŒä¸å˜ -->
            
            <!-- æ–°å¢å®‰å…¨è®¾ç½®é¡µé¢ -->
            <div id="security" class="tab-content">
                <h2 style="margin-bottom: 20px; font-size: 18px;">ğŸ”’ è®¾å¤‡å®‰å…¨è®¾ç½®</h2>
                
                <div class="security-settings">
                    <h3 style="margin-bottom: 15px; color: #f59e0b;">è®¾å¤‡å›ºå®šè®¾ç½®</h3>
                    
                    <div class="toggle-label">
                        <span>ğŸ” å¯ç”¨è®¾å¤‡å›ºå®š</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableDeviceFix" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="toggle-label">
                        <span>ğŸ“± ä»…å…è®¸å›ºå®šè®¾å¤‡è®¿é—®</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="strictMode">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>æœ€å¤§å›ºå®šè®¾å¤‡æ•°é‡ï¼š</label>
                        <input type="number" class="form-control" id="maxFixedDevices" value="5" min="1" max="20">
                    </div>
                </div>
                
                <div class="device-table">
                    <div class="table-header">
                        <div>è®¾å¤‡æ ‡è¯†</div>
                        <div>è®¾å¤‡ä¿¡æ¯</div>
                        <div>æœ€åç™»å½•</div>
                        <div>çŠ¶æ€</div>
                    </div>
                    <div id="fixedDevicesList">
                        <!-- å›ºå®šè®¾å¤‡åˆ—è¡¨ -->
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="addCurrentDevice()" style="margin-bottom: 10px;">
                        ğŸ“± å›ºå®šå½“å‰è®¾å¤‡
                    </button>
                    <button class="btn btn-danger" onclick="clearAllFixedDevices()">
                        ğŸ—‘ï¸ æ¸…ç©ºå›ºå®šè®¾å¤‡
                    </button>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½®ä¿æŒä¸å˜ -->
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡†ä¿æŒä¸å˜ -->

    <script>
        // å®‰å…¨é…ç½®
        const SECURITY_CONFIG = {
            VALID_TOKENS: [
                '8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92', // 123456
            ],
            TOKEN_EXPIRY: 24 * 60 * 60 * 1000,
            MAX_LOGIN_ATTEMPTS: 5,
            LOCKOUT_TIME: 15 * 60 * 1000
        };

        // è®¾å¤‡å›ºå®šé…ç½®
        let deviceFixConfig = {
            enabled: true,
            strictMode: false,
            maxFixedDevices: 5,
            fixedDevices: [] // å­˜å‚¨å›ºå®šè®¾å¤‡ä¿¡æ¯
        };

        // å½“å‰è®¾å¤‡æŒ‡çº¹
        let currentDeviceFingerprint = null;

        // åˆå§‹åŒ–è®¾å¤‡æŒ‡çº¹
        function initDeviceFingerprint() {
            // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ï¼ˆåŸºäºæµè§ˆå™¨ç‰¹å¾ï¼‰
            const fingerprint = generateDeviceFingerprint();
            currentDeviceFingerprint = fingerprint;
            
            // åŠ è½½è®¾å¤‡å›ºå®šé…ç½®
            const savedConfig = localStorage.getItem('deviceFixConfig');
            if (savedConfig) {
                deviceFixConfig = JSON.parse(savedConfig);
            }
            
            // æ£€æŸ¥å½“å‰è®¾å¤‡æ˜¯å¦å·²å›ºå®š
            checkCurrentDeviceStatus();
        }

        // ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
        function generateDeviceFingerprint() {
            const components = [
                navigator.userAgent,
                navigator.platform,
                navigator.language,
                screen.width + 'x' + screen.height,
                new Date().getTimezoneOffset()
            ].join('|');
            
            // ç®€å•å“ˆå¸Œå‡½æ•°
            let hash = 0;
            for (let i = 0; i < components.length; i++) {
                const char = components.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'device_' + Math.abs(hash).toString(16);
        }

        // æ£€æŸ¥å½“å‰è®¾å¤‡çŠ¶æ€
        function checkCurrentDeviceStatus() {
            if (!deviceFixConfig.enabled) return true;
            
            const isFixed = deviceFixConfig.fixedDevices.some(device => 
                device.fingerprint === currentDeviceFingerprint
            );
            
            if (deviceFixConfig.strictMode && !isFixed) {
                showToast('âŒ å½“å‰è®¾å¤‡æœªæˆæƒï¼Œç¦æ­¢è®¿é—®');
                logout();
                return false;
            }
            
            return true;
        }

        // å›ºå®šå½“å‰è®¾å¤‡
        function addCurrentDevice() {
            if (!currentDeviceFingerprint) {
                showToast('æ— æ³•è¯†åˆ«å½“å‰è®¾å¤‡');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²è¾¾æœ€å¤§æ•°é‡
            if (deviceFixConfig.fixedDevices.length >= deviceFixConfig.maxFixedDevices) {
                showToast(`å·²è¾¾åˆ°æœ€å¤§å›ºå®šè®¾å¤‡æ•°é‡ (${deviceFixConfig.maxFixedDevices})`);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å›ºå®š
            if (deviceFixConfig.fixedDevices.some(device => 
                device.fingerprint === currentDeviceFingerprint)) {
                showToast('å½“å‰è®¾å¤‡å·²å›ºå®š');
                return;
            }
            
            const deviceInfo = {
                fingerprint: currentDeviceFingerprint,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screen: screen.width + 'x' + screen.height,
                fixedTime: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                isCurrent: true
            };
            
            deviceFixConfig.fixedDevices.push(deviceInfo);
            saveDeviceFixConfig();
            loadFixedDevicesList();
            
            showToast('âœ… å½“å‰è®¾å¤‡å·²å›ºå®š');
        }

        // åŠ è½½å›ºå®šè®¾å¤‡åˆ—è¡¨
        function loadFixedDevicesList() {
            const fixedDevicesList = document.getElementById('fixedDevicesList');
            fixedDevicesList.innerHTML = '';
            
            deviceFixConfig.fixedDevices.forEach((device, index) => {
                const isCurrent = device.fingerprint === currentDeviceFingerprint;
                const row = document.createElement('div');
                row.className = 'table-row' + (isCurrent ? ' device-fixed' : '');
                
                row.innerHTML = `
                    <div>
                        ${device.fingerprint.substring(0, 8)}...
                        ${isCurrent ? '<span class="fixed-badge">å½“å‰</span>' : ''}
                    </div>
                    <div>
                        <small>${device.platform}</small><br>
                        <small>${device.screen}</small>
                    </div>
                    <div>
                        ${new Date(device.lastLogin).toLocaleDateString()}<br>
                        <small>${new Date(device.lastLogin).toLocaleTimeString()}</small>
                    </div>
                    <div>
                        <span class="status-badge status-active">å·²å›ºå®š</span>
                        <button class="btn btn-danger" onclick="removeFixedDevice('${device.fingerprint}')" 
                                style="padding: 4px 8px; font-size: 11px; margin-top: 5px;">
                            ç§»é™¤
                        </button>
                    </div>
                `;
                fixedDevicesList.appendChild(row);
            });
            
            // æ›´æ–°è®¾ç½®ç•Œé¢
            document.getElementById('enableDeviceFix').checked = deviceFixConfig.enabled;
            document.getElementById('strictMode').checked = deviceFixConfig.strictMode;
            document.getElementById('maxFixedDevices').value = deviceFixConfig.maxFixedDevices;
        }

        // ç§»é™¤å›ºå®šè®¾å¤‡
        function removeFixedDevice(fingerprint) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤æ­¤å›ºå®šè®¾å¤‡å—ï¼Ÿ')) return;
            
            deviceFixConfig.fixedDevices = deviceFixConfig.fixedDevices.filter(
                device => device.fingerprint !== fingerprint
            );
            saveDeviceFixConfig();
            loadFixedDevicesList();
            showToast('è®¾å¤‡å·²ä»å›ºå®šåˆ—è¡¨ä¸­ç§»é™¤');
        }

        // æ¸…ç©ºæ‰€æœ‰å›ºå®šè®¾å¤‡
        function clearAllFixedDevices() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›ºå®šè®¾å¤‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            
            deviceFixConfig.fixedDevices = [];
            saveDeviceFixConfig();
            loadFixedDevicesList();
            showToast('æ‰€æœ‰å›ºå®šè®¾å¤‡å·²æ¸…ç©º');
        }

        // ä¿å­˜è®¾å¤‡å›ºå®šé…ç½®
        function saveDeviceFixConfig() {
            localStorage.setItem('deviceFixConfig', JSON.stringify(deviceFixConfig));
        }

        // æ›´æ–°è®¾å¤‡å›ºå®šè®¾ç½®
        function updateDeviceFixSettings() {
            deviceFixConfig.enabled = document.getElementById('enableDeviceFix').checked;
            deviceFixConfig.strictMode = document.getElementById('strictMode').checked;
            deviceFixConfig.maxFixedDevices = parseInt(document.getElementById('maxFixedDevices').value) || 5;
            
            saveDeviceFixConfig();
            
            if (deviceFixConfig.strictMode && !checkCurrentDeviceStatus()) {
                return;
            }
            
            showToast('å®‰å…¨è®¾ç½®å·²ä¿å­˜');
        }

        // å¢å¼ºçš„ç™»å½•å‡½æ•°
        async function loginWithToken() {
            // ... åŸæœ‰çš„ä»¤ç‰ŒéªŒè¯é€»è¾‘ ...
            
            // ç™»å½•æˆåŠŸåæ›´æ–°è®¾å¤‡ä¿¡æ¯
            if (deviceFixConfig.enabled && currentDeviceFingerprint) {
                const fixedDevice = deviceFixConfig.fixedDevices.find(
                    device => device.fingerprint === currentDeviceFingerprint
                );
                
                if (fixedDevice) {
                    fixedDevice.lastLogin = new Date().toISOString();
                    saveDeviceFixConfig();
                }
            }
            
            // æ£€æŸ¥è®¾å¤‡å›ºå®š
            if (!checkCurrentDeviceStatus()) {
                return;
            }
        }

        // ä¿®æ”¹æ˜¾ç¤ºç®¡ç†é¡µé¢å‡½æ•°
        function showAdminPage() {
            // ... åŸæœ‰é€»è¾‘ ...
            
            // åŠ è½½è®¾å¤‡å›ºå®šåˆ—è¡¨
            loadFixedDevicesList();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initDeviceFingerprint();
            checkLoginStatus();
            setupTabNavigation();
            loadSettings();
        });

        // åœ¨å®‰å…¨è®¾ç½®é¡µé¢æ·»åŠ äº‹ä»¶ç›‘å¬
        document.getElementById('enableDeviceFix').addEventListener('change', updateDeviceFixSettings);
        document.getElementById('strictMode').addEventListener('change', updateDeviceFixSettings);
        document.getElementById('maxFixedDevices').addEventListener('change', updateDeviceFixSettings);
    </script>
</body>
</html>
